{% extends "ui/layouts/base.html" %}

{% load fb_versions common_tags %}

{% block title %}Home{% endblock %}
{% block body_class %}students{% endblock %}

{% block content %}
  <section class="blue feature-box"><div class="inner">
    <h1>Sign Up</h1>
  </div></section>
  
  <section>
  
    <form action="" id="student-signup-form" method="post" class="nice" enctype="multipart/form-data">
	{% csrf_token %}
      <div class="row">
        <div class="twelve columns">
          <h3>Personal Details</h3>
        </div>
      </div>
    
      <div class="row">
        <div class="eight columns">
          <label>Name</label>
          
         {% if form.first_name.errors %}<div class="formError">First name is required</div>{% endif %}
         {% if form.last_name.errors %}<div class="formError">Last name is required</div>{% endif %}
          <div class="row space">
            <div class="six columns">
              <input name="first_name" type="text" class="input-text" placeholder="First Name" value="{{form.first_name.value}}">
            </div>
            <div class="six columns">
              <input name="last_name" type="text" class="input-text" placeholder="Last Name" value="{{form.last_name.value}}">
            </div>
          </div>
          
          <div class="row space">
            <div class="three columns">
              <label>Gender</label>
            </div>
            <div class="nine columns">
              {{form.gender}}
            </div>
          </div>
          
          <div class="row space">
            <div class="three columns">
              <label>D.O.B</label>
            </div>
            
          {% if form.date_of_birth.errors %}<div class="formError">{{ form.date_of_birth.errors }}</div>{% endif %}
            <div class="nine columns">
              <input id="id_date_of_birth" name="date_of_birth" type="text" class="input-text clear hidden" value="{{form.date_of_birth.value}}">
              <div class="row">
                <div class="four columns phone-one">
                  <select id="id_dob_day" class="stretch signup_dob2">
                  </select>
                </div>
                <div class="four columns phone-one">
                  <select id="id_dob_month" class="stretch signup_dob2">
                  </select>
                </div>
                <div class="four columns phone-two">
                  <select id="id_dob_year" class="stretch signup_dob2">
                  </select>
                </div>
              </div>
            </div>
          </div>
          
          {% if form.country.errors %}<div class="formError">{{ form.country.errors }}</div>{% endif %}
          <div class="row date_of_birth">
            <div class="three columns phone-one">
              <label>Country</label>
            </div>
            <div class="nine columns phone-three">
              {{form.country}}
            </div>  
          </div>

          {% if form.timezone.errors %}<div class="formError">{{ form.timezone.errors }}</div>{% endif %}
          <div class="row date_of_birth">
            <div class="three columns phone-one">
              <label>Timezone</label>
            </div>
            <div class="nine columns phone-three">
              	{{form.timezone}}
            </div>  
          </div>
          
		  {% if form.username.errors %}<div class="formError">{{ form.username.errors }}</div>{% endif %}
          <div class="row space">
            <div class="three columns">
              <label>Username</label>
            </div>
            <div class="nine columns">
              <input type="text" id="id_username" name="username" value="{{ form.username.value }}" class="input-text oversize stretch" />
            </div>
          </div>
          
		  {% if form.email.errors %}<div class="formError">{{ form.email.errors }}</div>{% endif %}
          <div class="row space">
            <div class="three columns">
              <label>Email</label>
            </div>
            <div class="nine columns">
              <input type="text" id="id_email" name="email" value="{{ form.email.value }}" class="input-text oversize stretch" />
            </div>
          </div>

		  {% if form.password1.errors %}<div class="formError">{{ form.password1.errors }}</div>{% endif %}
		  {% if form.password2.errors %}<div class="formError">{{ form.password2.errors }}</div>{% endif %}
          <div class="row">
            <div class="three columns">
              <label>Account Password</label>
            </div>
            <div class="four columns">
              <input type="password" id="id_password1" name="password1" value="" class="input-text oversize stretch" />
            </div>
            <div class="four columns">
              <input type="password" id="id_password2" name="password2" value="" class="input-text oversize stretch" />
            </div>
          </div>
          
          <hr class="inside">

	      <div class="row">
	        <div class="twelve columns">
	          <h3>Referral</h3>
	        </div>
	      </div>

          {% if form.referral.errors %}<div class="formError">{{ form.referral.errors }}</div>{% endif %}
          <div class="row date_of_birth">
            <div class="three columns phone-one">
              <label>How did you know about us?</label>
            </div>
            <div class="nine columns phone-three">
              	{{form.referral}}
            </div>  
          </div>

		  {% if form.referral_other.errors %}<div class="formError">{{ form.referral_other.errors }}</div>{% endif %}
          <div id="id_div_referral_other" class="row space hidden">
            <div class="three columns">
              <label>Other option</label>
            </div>
            <div class="nine columns">
              <input type="text" id="id_referral_other" name="referral_other" value="{% if form.referral_other.value %}{{ form.referral_other.value }}{% endif %}" class="input-text oversize stretch" />
            </div>
          </div>
          
		  {% if form.referral_key.errors %}<div class="formError">{{ form.referral_key.errors }}</div>{% endif %}
          <div class="row space">
            <div class="three columns">
              <label>Referral Key</label>
            </div>
            <div class="nine columns">
              <input type="text" id="id_referral_key" name="referral_key" value="{% if form.referral_key.value %}{{ form.referral_key.value }}{% endif %}" class="input-text oversize stretch" />
            </div>
          </div>
          
          <hr class="inside">
          
	      <div class="row">
	        <div class="twelve columns">
	          <h3>Interests</h3>
	        </div>
	      </div>
          
          <label>Type an Interest to add</label>
          <div id="tracked-subject-error" class="formError"></div>
          <div id="div_id_fake_container" class="row">
            <div class="six columns">
              <input id="autocomplete-subject" type="text" class="input-text">
              <textarea id="id_subjects" name="subjects" class="hidden"></textarea>
              <textarea id="id_new_subjects" name="new_subjects" class="hidden"></textarea>
            </div>
            <div class="six columns">
              <div id="div_id_subjects_container" class="tags clear">
              </div>
            </div>
          </div>
          
          <hr class="inside">
          
		  <div id="model-signup-button" class="large button"><input type="submit" class="icon rocket" value="Create My Account" /></div>
		  <div id="model-signup-under16-container2" class="hidden formError">
				Under 16? Your parent need to create a account for you. <br />
		  </div>          
          
        </div>
        
        <div class="four columns photo">
          <img id="id_image_preview" src="http://placehold.it/175x175" alt="Profile Picture" style="max-width: 175px; max-height: 175px;">
          <div><input id="id_profile_image" class="upload clear" type="file" name="profile_image" size="40"></div>
        </div>
        
      </div>
    
    </form>
  </section>
  
<script type="text/javascript">
	var today = new Date();
	var today_year = today.getFullYear();
	
	var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'October', 'November', 'December'];

	function getQueryVariable(variable)
	{
	       var query = window.location.search.substring(1);
	       var vars = query.split("&");
	       for (var i=0;i<vars.length;i++) {
	               var pair = vars[i].split("=");
	               if(pair[0] == variable){return pair[1];}
	       }
	       return '';
	}
	
	var dob_date = getQueryVariable('date');
	dob_date = dob_date.split('-');
	
	var dob_year = parseInt(dob_date[0]);
	var dob_month = parseInt(dob_date[1]);
	var dob_day = parseInt(dob_date[2]);

	for(i=1; i<=31; i++)
		$('#id_dob_day').append('<option value="'+ i +'" '+ (i==dob_day?'selected=selected':'') +'>'+ i +'</option>');

	for(i=0; i<months.length; i++)
		$('#id_dob_month').append('<option value="'+ (i+1) +'" '+ (i==dob_month-1?'selected=selected':'') +'>'+ months[i] +'</option>');

	for(i=today_year; i>today_year-100; i--)
		$('#id_dob_year').append('<option value="'+ i +'" '+ (i==dob_year?'selected=selected':'') +'>'+ i +'</option>');
		
	$('.signup_dob2').change(function(e){
		check_over16_2();
	});
	
	$('#student-signup-form').submit(function(){
		$('#id_date_of_birth').val( $('#id_dob_year').val() +'-'+ $('#id_dob_month').val() +'-'+ $('#id_dob_day').val() );
	});
	
	$('#id_profile_image').change(function(){
        var input = $(this)[0]
        if (input.files && input.files[0]) {
            var reader = new FileReader();

            reader.onload = function (e) {
                $('#id_image_preview').attr('src', e.target.result);
            }

            reader.readAsDataURL(input.files[0]);
        }		
	});

	$('#id_referral').change(function(){
		if( $(this).val() == '20' ) {
			$('#id_div_referral_other').removeClass('hidden');
		} else {
			$('#id_div_referral_other').addClass('hidden');
		}
	});

	var ac_subject = new AutoComplete({
		'id': 'ac_subject',
		'inputId': '#autocomplete-subject',
		'formId': '#student-signup-form',
		'errorCls': '#tracked-subject-error',
		'main_container': '#div_id_fake_container',
		'list_container': '#div_id_subjects_container',
		'url': '{% url autocomplete_subjects %}',
		'add_new_items': true,
		'id_items': '#id_subjects',
		'id_new_items': '#id_new_subjects',
		'max': 12
	});

	var check_over16_2 = function(){
		var day = parseInt($('#id_dob_day').val());
		var month = parseInt($('#id_dob_month').val());
		var year = parseInt($('#id_dob_year').val());
		var date = new Date(year, month-1, day);
		var str_date = date.getFullYear() +'-'+ (date.getMonth()+1) +'-'+ date.getDate();
		var input_date = year +'-'+ month +'-'+ day;

		if(str_date == input_date) {			
			var age_date = new Date(year+16, month, day);
			var today = new Date();
			
			if(today >= age_date) {
				$('#model-signup-button').removeClass('hidden');
				$('#model-signup-under16-container2').addClass('hidden');
				return true;
			} else {
				$('#model-signup-button').addClass('hidden');
				$('#model-signup-under16-container2').removeClass('hidden');
				return false;
			}
		}
		
		return false;
	}
	
	$('#student-signup-form').submit(function(e){
		if(!check_over16_2()){
			e.preventDefault();
		}
	});
</script>
{% endblock %}
