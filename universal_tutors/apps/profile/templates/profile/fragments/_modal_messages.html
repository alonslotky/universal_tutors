<div id="modal-message" class="reveal-modal message">
  <h4>To: <strong id="modal-messages-user"></strong></h4>
  
  <div class="messages">
    <div class="top"></div>
    <div id="modal-messages-loading" class="inside loading">
    	
    </div>
    <div id="modal-messages-container" class="inside">

    </div>
  </div>

  {% if user == person or can_send_message or messages.length > 0 %}
  <form id="modal-message-form" class="nice" method="post">
  	{% csrf_token %}
    {% if user_profile.type == user_profile.TYPES.PARENT %}
    <div class="row">
	  <div class="two columns phone-one">        
	    <label>Child*</label>
	  </div>
	  <div class="ten columns phone-three">
		<select id="message-child" name="child" class="stretch">
			<option value="0">---------</option>
			{% for item in user.children.all %}
			{% with item.child as child %}
			<option value="{{child.id}}">{{child.get_full_name}}</option>
			{% endwith %}
			{% endfor %}
		</select>
	  </div>	  
    </div>				
    {% endif %}
    <div class="row">
      <div class="nine columns">
        <textarea id="modal-message-text" name="modal-message-text" type="text" class="text-area" placeholder="Write a Message ..."></textarea>
      </div>
      
      <div class="three columns">
        <input type="submit" class="small button" value="Send">
      </div>
    </div>
  </form>
  {% endif %}

  <a class="close-reveal-modal" onclick="clearTimeout(modal_message_timeout);">&#215;</a>
</div>
<script type="text/javascript">
	var modal_message_to;
	var modal_message_class;
	var modal_message_timeout;

	var view_modal_messages = function(to, class_, force_stay) {
		clearTimeout(modal_message_timeout);
		modal_message_to = to;
		modal_message_class = class_;
			
		{% if user.is_authenticated %}
		var url = '{% url view_modal_messages user.username %}'+ to +'/';
		url += class_ ? class_+'/' : '';
		{% endif %}
		
		if(!force_stay) {
			$('#modal-messages-container').hide();
			$('#modal-messages-loading').show();
		}
		
		$.ajax({
			type: 'get',
			url: url,
			complete: function() {
				$('#modal-messages-loading').fadeOut(function(){
						$('#modal-messages-container').fadeIn();
				});	
			},
			error: function() {
				$('#modal-messages-container').html("It is not possible show the messages right now. Please try again later.")
				$("#modal-message-form").hide();
			},
			success: function(response) {
				load_modal_messages(response);
				modal_message_timeout = setTimeout(function(){ view_modal_messages(modal_message_to, modal_message_class, true); }, 2000);
			}
		});
	};
	
	$('#modal-message-form').submit(function(e){
		e.preventDefault();
		
		var child = {% if user_profile.type == user_profile.TYPES.PARENT %}parseInt($('#message-child').val()){% else %}true;{% endif %}
		
		if (modal_message_to && $('#modal-message-text').val() && child) {
			var url = '{% url send_modal_message %}'+ modal_message_to +'/';
			url += modal_message_class ? modal_message_class+'/' : '';
	
			$.ajax({
				type: 'post',
				data: $('#modal-message-form').serialize(),
				url: url,
				complete: function() {
					$('#modal-messages-loading').fadeOut(function(){
							$('#modal-messages-container').fadeIn();
					});	
				},
				error: function() {
					$('#modal-messages-container').html("It is not possible show the messages right now. Please try again later.")
				},
				success: function(response) {
					$('#modal-message-text').val('');
					$('#modal-message-text').css('height', '30px');
					$('#modal-message-text').height($('#modal-message-text').get(0).scrollHeight + 15);
					load_modal_messages(response);
				}
			});
		}
	});
	
	var load_modal_messages = function(response) {
		var result = eval(response);
		
		$('#modal-messages-user').html(result.to);
		$('#modal-messages-container').html('');

		var messages = result.messages;				
		for(i=0; i<messages.length; i++){
			var message = messages[i];
			$('#modal-messages-container').append(
				'<div class="post '+ (message.user_id==modal_message_to?'them':'you') +'">'+
				'	<h6>'+ message.user + (message.child?' ('+ message.child +'\'s parent)':'') +'</h6>'+
				'	<p>'+ message.text +'</p>'+
				'</div>'
			);
		}

		if(messages.length) {
			$('.message-user-'+ modal_message_to +'-link').html('<i class="icon-comment"></i> View Messages');
		} else {
			$('.message-user-'+ modal_message_to +'-link').html('<i class="icon-comment"></i> Send a Message');			
		}
		$('.message-user-'+ modal_message_to +'-value').addClass('hidden');

		
		$('#modal-messages-container').scrollTop(9999999);
	};
	
	$('#modal-message-text').val('');
	$('#modal-message-text').css({
		'height': '30px',
		'min-height': '30px',
		'overflow': 'hidden',
		'resize': 'none'
	});
	$('#modal-message-text').keyup(function(e){
		$('#modal-message-text').css('height', '30px');
		$('#modal-message-text').height($(this).get(0).scrollHeight + 15);
	});
	$('#modal-message-text').keypress(function(e){
		var code = (e.keyCode ? e.keyCode : e.which);
		if(code == 13) {
			$('#modal-message-form').submit();
		}
	});
	
</script>